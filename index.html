<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LawGear Pacemaker — 개인회생 90일 전환 대시보드</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#111c3a;
      --muted:#aab6d3;
      --text:#e9eeff;
      --line:rgba(255,255,255,.10);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#60a5fa;
      --chip:#1b2a55;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 600px at 85% 5%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(1000px 700px at 50% 110%, rgba(245,158,11,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    header{
      padding:28px 16px 10px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
    }
    .title{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(34,197,94,.85));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:900;
      color:#071026;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:12px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button, .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:700;
      font-size:13px;
    }
    button:hover, .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    button:active{transform: translateY(0)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(245,158,11,.95), rgba(239,68,68,.85));
      border: none;
      color:#0b1020;
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(96,165,250,.75));
      border:none;color:#0b1020;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 16px 40px;
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ main{grid-template-columns: 1fr} }

    .panel{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .panel .hd h2{font-size:13px;margin:0;letter-spacing:.2px;}
    .panel .bd{padding:14px}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .card{
      background: rgba(17,28,58,.75);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:12px;
    }
    .metric{display:flex; justify-content:space-between; align-items:flex-end; gap:10px;}
    .metric .k{font-size:12px;color:var(--muted);font-weight:700}
    .metric .v{font-size:18px;font-weight:900}
    .tiny{font-size:11px;color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background: rgba(27,42,85,.85);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      display:flex;gap:8px;align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .chip[data-active="true"]{outline:2px solid rgba(96,165,250,.65)}
    .dot{width:8px;height:8px;border-radius:999px}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:var(--info)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    label{font-size:12px;color:var(--muted);font-weight:800; display:block; margin:0 0 6px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:rgba(233,238,255,.82)}
    .hint b{color:var(--text)}
    .warnbox{
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      padding:10px 12px;
      border-radius:14px;
      color: rgba(233,238,255,.92);
      font-size:12px;
      font-weight:700;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:12px;
      font-weight:900;
    }

    /* Calendar */
    .calendar{display:grid;grid-template-columns: repeat(10, 1fr);gap:8px;}
    @media (max-width: 980px){ .calendar{grid-template-columns: repeat(6, 1fr)} }
    .day{
      background: rgba(17,28,58,.72);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px 10px 8px;
      cursor:pointer;
      position:relative;
      min-height:74px;
      transition:.12s ease;
    }
    .day:hover{transform: translateY(-1px); background: rgba(17,28,58,.92)}
    .day.selected{outline:2px solid rgba(96,165,250,.75)}
    .day .num{
      font-weight:900;
      font-size:12px;
      color: rgba(233,238,255,.92);
      display:flex; justify-content:space-between; align-items:center;
    }
    .badge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(233,238,255,.86);
      font-weight:900;
    }
    .badge.good{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .badge.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12)}
    .badge.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}
    .day .mini{margin-top:8px;font-size:10px;color: rgba(170,182,211,.95);display:flex; gap:6px; flex-wrap:wrap;}
    .mini span{background: rgba(27,42,85,.75);border:1px solid rgba(255,255,255,.08);padding:4px 6px;border-radius:999px;font-weight:800;}

    .checklist{display:grid;gap:8px;}
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .check input{margin-top:2px}
    .check .t{font-weight:900;font-size:13px}
    .check .d{font-size:11px;color:var(--muted);margin-top:2px}

    /* Prompt box */
    .promptBox{
      background: rgba(10,16,34,.65);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }
    .promptActions{display:flex;gap:8px;flex-wrap:wrap}
    .promptText{
      width:100%;
      min-height:220px;
      margin-top:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.55;
    }

    .footer-note{
      max-width:1200px;
      margin:0 auto;
      padding: 0 16px 24px;
      color: rgba(170,182,211,.95);
      font-size:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="logo">LG</div>
      <div>
        <h1>LawGear Pacemaker — 개인회생 90일 전환 대시보드</h1>
        <div class="subtitle">광고비 0원 / 블로그만으로 전환 테스트 → 확장. (데이터는 브라우저 <span class="mono">localStorage</span>에 저장)</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn good" id="btnToday">오늘로 이동</button>
      <button class="btn" id="btnExport">백업(JSON)</button>
      <label class="btn" for="importFile" style="cursor:pointer">복원(JSON)</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button class="btn" id="btnReset">초기화</button>
      <button class="btn primary" id="btnAutoFill">90일 키워드/유형 자동배치</button>
    </div>
  </header>

  <main>
    <!-- LEFT -->
    <section class="panel">
      <div class="hd">
        <h2>오늘의 퀘스트 & 선택한 Day 편집</h2>
        <span class="pill" id="dayLabel">Day 1</span>
      </div>
      <div class="bd">

        <div class="grid2">
          <div class="card">
            <div class="metric">
              <div>
                <div class="k">진행률</div>
                <div class="tiny">완료한 Day / 90</div>
              </div>
              <div class="v" id="progressPct">0%</div>
            </div>
            <div class="sep"></div>
            <div class="tiny">완료: <b id="doneCount">0</b> / 90</div>
          </div>

          <div class="card">
            <div class="metric">
              <div>
                <div class="k">전환 체크</div>
                <div class="tiny">CTA 클릭/문의(수기)</div>
              </div>
              <div class="v" id="leadCount">0</div>
            </div>
            <div class="sep"></div>
            <div class="tiny">※ 수기 기록 기준</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div style="flex:1; min-width:220px">
            <label>90일 시작일</label>
            <input type="text" id="startDate" placeholder="예) 2026-02-16" />
            <div class="tiny">비워두면 “오늘”이 Day 1</div>
          </div>
          <div style="flex:1; min-width:220px">
            <label>현재 선택 Day</label>
            <select id="daySelect"></select>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <div>
            <label>글 유형(템플릿)</label>
            <select id="postType">
              <option value="전환형-비교결단">전환형-비교결단</option>
              <option value="전환형-실패경고">전환형-실패경고</option>
              <option value="전환형-위기대응">전환형-위기대응</option>
              <option value="신뢰형-승인사례">신뢰형-승인사례</option>
              <option value="SEO형-기본정보">SEO형-기본정보</option>
            </select>
          </div>
          <div>
            <label>키워드 의도</label>
            <select id="intent">
              <option value="고의도">고의도</option>
              <option value="중의도">중의도</option>
              <option value="저의도">저의도</option>
            </select>
          </div>
        </div>

        <div class="sep"></div>

        <label>SEO 제목 /// 메인키워드</label>
        <input type="text" id="titleKeyword" placeholder="예) 개인회생 변호사 비용 비교///개인회생 변호사 비용" />

        <div class="sep"></div>

        <div class="grid2">
          <div>
            <label>작성/발행 URL (선택)</label>
            <input type="text" id="url" placeholder="https://..." />
          </div>
          <div>
            <label>성과 메모 (수기)</label>
            <input type="text" id="resultMemo" placeholder="예) CTA 클릭 2, 문의 1" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="warnbox">
          <b>고정 규칙(프롬프트에도 반영됨)</b><br>
          ① H2 7개 고정 ② H2#1~#6 하위 H3 최소 1개 ③ H2#7 하위 H3 금지<br>
          ④ FAQ는 Q1~Q5 “5개 고정” ⑤ CTA 3개 분산( H2#2 / H2#4 / FAQ 2개 이후 )
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <div class="card">
            <div class="metric">
              <div>
                <div class="k">CTA 클릭(수기)</div>
                <div class="tiny">오늘 기록</div>
              </div>
              <div class="v" id="ctaClicksVal">0</div>
            </div>
            <div class="sep"></div>
            <label class="tiny">오늘 CTA 클릭 수</label>
            <input type="number" id="ctaClicks" min="0" step="1" />
          </div>

          <div class="card">
            <div class="metric">
              <div>
                <div class="k">문의/리드(수기)</div>
                <div class="tiny">폼/카톡/전화</div>
              </div>
              <div class="v" id="leadsVal">0</div>
            </div>
            <div class="sep"></div>
            <label class="tiny">오늘 문의(리드) 수</label>
            <input type="number" id="leads" min="0" step="1" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <button class="btn good" id="btnMarkDone">✅ 오늘 Day 완료 처리</button>
          <button class="btn" id="btnUnDone">↩️ 완료 취소</button>
        </div>

        <div class="sep"></div>

        <label>체크리스트</label>
        <div class="checklist" id="checklist"></div>

        <div class="sep"></div>

        <label>메모(자유)</label>
        <textarea id="notes" placeholder="예) CTA 문구가 약했음 / 다음 글에서 '기각' 키워드 강화 / 내부링크 구조 수정"></textarea>

        <div style="height:10px"></div>
        <button class="btn" id="btnSave">저장</button>

        <div class="sep"></div>

        <!-- NEW: Prompt Generator -->
        <div class="promptBox">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div style="font-weight:900">프롬프트 자동 생성</div>
            <div class="promptActions">
              <button class="btn good" id="btnMakePrompt">프롬프트 생성</button>
              <button class="btn" id="btnCopyPrompt">복사</button>
            </div>
          </div>
          <div class="tiny" style="margin-top:6px">
            선택한 Day의 <span class="mono">제목///키워드</span>·유형·의도 값을 반영해 “개인회생 글 생성 프롬프트”를 만든다.
          </div>
          <textarea class="promptText" id="promptText" spellcheck="false" placeholder="여기에 프롬프트가 생성됩니다."></textarea>
        </div>

      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div class="hd">
        <h2>90일 캘린더 & 필터</h2>
        <div class="chips">
          <div class="chip" data-filter="all" data-active="true"><span class="dot info"></span>전체</div>
          <div class="chip" data-filter="done"><span class="dot good"></span>완료</div>
          <div class="chip" data-filter="todo"><span class="dot warn"></span>미완료</div>
          <div class="chip" data-filter="leads"><span class="dot bad"></span>리드 발생</div>
        </div>
      </div>

      <div class="bd">
        <div class="grid3">
          <div class="card">
            <div class="metric">
              <div>
                <div class="k">이번 주 목표</div>
                <div class="tiny">주 14포 기준</div>
              </div>
              <div class="v" id="weekTarget">14</div>
            </div>
            <div class="sep"></div>
            <div class="tiny">3포/일이면 목표 초과 가능</div>
          </div>

          <div class="card">
            <div class="metric">
              <div>
                <div class="k">전환형 비중</div>
                <div class="tiny">전환형 3종 합계</div>
              </div>
              <div class="v" id="convRatio">0%</div>
            </div>
            <div class="sep"></div>
            <div class="tiny">권장: <b>60%+</b> (초기 30일)</div>
          </div>

          <div class="card">
            <div class="metric">
              <div>
                <div class="k">내부링크 규율</div>
                <div class="tiny">link5 체크 Day</div>
              </div>
              <div class="v" id="linkDiscipline">0</div>
            </div>
            <div class="sep"></div>
            <div class="tiny">권장: 90일 중 <b>70일+</b></div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div style="flex:1; min-width:220px">
            <label>빠른 검색</label>
            <input type="text" id="search" placeholder="키워드/제목 일부 검색" />
          </div>
          <div style="flex:1; min-width:220px">
            <label>유형 필터</label>
            <select id="typeFilter">
              <option value="all">전체</option>
              <option value="전환형-비교결단">전환형-비교결단</option>
              <option value="전환형-실패경고">전환형-실패경고</option>
              <option value="전환형-위기대응">전환형-위기대응</option>
              <option value="신뢰형-승인사례">신뢰형-승인사례</option>
              <option value="SEO형-기본정보">SEO형-기본정보</option>
            </select>
          </div>
          <div style="flex:1; min-width:220px">
            <label>의도 필터</label>
            <select id="intentFilter">
              <option value="all">전체</option>
              <option value="고의도">고의도</option>
              <option value="중의도">중의도</option>
              <option value="저의도">저의도</option>
            </select>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="calendar" id="calendar"></div>

        <div class="sep"></div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
            <div>
              <div style="font-weight:900;font-size:13px;margin-bottom:6px">운영 원칙</div>
              <div class="hint">
                ① 고의도/전환형 먼저 ② FAQ 5개(Q1~Q5) 고정 ③ CTA 분산 3개 ④ 과장/단정 금지
              </div>
            </div>
            <div class="chips">
              <span class="chip" style="cursor:default"><span class="dot good"></span>완료</span>
              <span class="chip" style="cursor:default"><span class="dot warn"></span>미완료</span>
              <span class="chip" style="cursor:default"><span class="dot bad"></span>리드</span>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <div class="footer-note">
    ⚠️ 본 대시보드는 운영 도구입니다. 법률 자문이 아닙니다. 데이터는 이 브라우저에 저장됩니다.
  </div>

<script>
(() => {
  const STORAGE_KEY = "lawgear_pacemaker_rehab_90d_v2_prompt";

  const defaultChecklist = [
    { key:"cta3", title:"CTA 3개 삽입", desc:"H2#2 / H2#4 / FAQ 2개 이후 (CTA 뒤 p 1개)" },
    { key:"faq5", title:"FAQ 5개 고정", desc:"Q1~Q5 형식 고정, 질문/답변 개수 변경 금지" },
    { key:"link5", title:"내부링크 5개", desc:"허브글(변호사비용/승인확률)로 2개 이상 연결" },
    { key:"noHype", title:"과장/단정 금지", desc:"100%/무조건/확정 표현 금지, 케이스별 다름 명시" },
    { key:"proof", title:"근거/절차 명시", desc:"법원/절차/서류 흐름이 보이게 작성" },
  ];

  const conversionTypes = new Set(["전환형-비교결단","전환형-실패경고","전환형-위기대응"]);

  const seedTitles = [
    "개인회생 변호사 비용 비교///개인회생 변호사 비용",
    "개인회생 수임료 평균과 추가비용 함정///개인회생 수임료",
    "개인회생 승인확률 올리는 핵심 5가지///개인회생 승인확률",
    "개인회생 무료상담 전에 꼭 확인할 3가지///개인회생 무료상담",
    "개인회생 법무사 vs 변호사 뭐가 유리할까///개인회생 법무사 변호사",
    "개인회생 기각 사유 TOP7과 피하는 방법///개인회생 기각 사유",
    "개인회생 금지명령 기각되는 케이스///개인회생 금지명령 기각",
    "개인회생 재신청 가능 조건과 타이밍///개인회생 재신청",
    "개인회생 폐지되면 어떻게 되나 재진입 전략///개인회생 폐지",
    "개인회생 변제금 줄이는 방법 현실 정리///개인회생 변제금 줄이기",
    "개인회생 성공률이 갈리는 서류 포인트///개인회생 성공률",
    "개인회생 기각 후 재도전 로드맵///개인회생 기각 후",
    "개인회생 통장압류 풀리는 시점과 대응///개인회생 통장압류",
    "개인회생 채권자 이의신청 들어오면///개인회생 이의신청",
    "개인회생 보정권고 대응 못 하면 생기는 일///개인회생 보정권고",
    "개인회생 서류 준비 체크리스트///개인회생 준비서류",
    "개인회생 신청자격 조건 한 번에 정리///개인회생 신청자격",
    "개인회생 절차 기간 단계별 일정///개인회생 절차",
    "개인회생 금지명령 신청 방법///개인회생 금지명령",
    "개인회생 보정명령 자주 나오는 이유///개인회생 보정명령",
    "개인회생 변제계획안 작성 핵심///개인회생 변제계획안",
    "개인회생 채무한도와 포함되는 채무///개인회생 채무한도",
    "개인회생 면책 결정까지 걸리는 시간///개인회생 면책 기간",
    "개인회생 중 자동차 유지 가능할까///개인회생 자동차",
    "개인회생 중 대출 가능 여부///개인회생 대출",
    "개인회생 중 카드 사용 가능할까///개인회생 신용카드",
    "개인회생 소득 증빙 서류는 뭐가 필요///개인회생 소득증빙",
    "개인회생 배우자 재산 영향 범위///개인회생 배우자 재산",
    "개인회생 주거(전월세) 영향과 주의점///개인회생 전월세",
    "개인회생 이후 신용회복 기간 정리///개인회생 신용회복",
  ];

  const state = loadState();

  const el = {
    startDate: document.getElementById("startDate"),
    daySelect: document.getElementById("daySelect"),
    dayLabel: document.getElementById("dayLabel"),
    titleKeyword: document.getElementById("titleKeyword"),
    url: document.getElementById("url"),
    resultMemo: document.getElementById("resultMemo"),
    postType: document.getElementById("postType"),
    intent: document.getElementById("intent"),
    notes: document.getElementById("notes"),
    checklist: document.getElementById("checklist"),
    btnSave: document.getElementById("btnSave"),
    btnMarkDone: document.getElementById("btnMarkDone"),
    btnUnDone: document.getElementById("btnUnDone"),
    btnToday: document.getElementById("btnToday"),
    btnExport: document.getElementById("btnExport"),
    importFile: document.getElementById("importFile"),
    btnReset: document.getElementById("btnReset"),
    btnAutoFill: document.getElementById("btnAutoFill"),
    calendar: document.getElementById("calendar"),
    chips: Array.from(document.querySelectorAll(".chip[data-filter]")),
    search: document.getElementById("search"),
    typeFilter: document.getElementById("typeFilter"),
    intentFilter: document.getElementById("intentFilter"),
    progressPct: document.getElementById("progressPct"),
    doneCount: document.getElementById("doneCount"),
    leadCount: document.getElementById("leadCount"),
    ctaClicks: document.getElementById("ctaClicks"),
    leads: document.getElementById("leads"),
    ctaClicksVal: document.getElementById("ctaClicksVal"),
    leadsVal: document.getElementById("leadsVal"),
    weekTarget: document.getElementById("weekTarget"),
    convRatio: document.getElementById("convRatio"),
    linkDiscipline: document.getElementById("linkDiscipline"),
    // NEW
    btnMakePrompt: document.getElementById("btnMakePrompt"),
    btnCopyPrompt: document.getElementById("btnCopyPrompt"),
    promptText: document.getElementById("promptText"),
  };

  initStartDate();
  initDaySelect();
  bindEvents();
  renderAll();

  function initStartDate(){
    if(!state.startDate){
      state.startDate = formatDate(new Date());
      saveState();
    }
    el.startDate.value = state.startDate;
  }

  function initDaySelect(){
    el.daySelect.innerHTML = "";
    for(let i=1;i<=90;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `Day ${i}`;
      el.daySelect.appendChild(opt);
    }
    el.daySelect.value = String(state.selectedDay || 1);
  }

  function bindEvents(){
    el.daySelect.addEventListener("change", () => {
      state.selectedDay = Number(el.daySelect.value);
      saveState();
      renderAll();
    });

    el.startDate.addEventListener("change", () => {
      state.startDate = el.startDate.value.trim() || formatDate(new Date());
      saveState();
      renderCalendar();
    });

    el.btnSave.addEventListener("click", () => {
      applyEditorToDay();
      saveState();
      renderAll();
    });

    el.btnMarkDone.addEventListener("click", () => {
      applyEditorToDay();
      const d = getDay(state.selectedDay);
      d.done = true;
      saveState();
      renderAll();
    });

    el.btnUnDone.addEventListener("click", () => {
      const d = getDay(state.selectedDay);
      d.done = false;
      saveState();
      renderAll();
    });

    el.btnToday.addEventListener("click", () => {
      const dayNum = computeDayFromStart(state.startDate, new Date());
      state.selectedDay = clamp(dayNum,1,90);
      el.daySelect.value = String(state.selectedDay);
      saveState();
      renderAll();
    });

    el.btnExport.addEventListener("click", () => exportJSON());

    el.importFile.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!data || !data.days || !Array.isArray(data.days)) throw new Error("형식 오류");
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        location.reload();
      }catch(err){
        alert("복원 실패: JSON 형식이 올바르지 않습니다.");
      }finally{
        el.importFile.value = "";
      }
    });

    el.btnReset.addEventListener("click", () => {
      if(!confirm("정말 초기화할까요? (저장된 90일 데이터가 삭제됩니다)")) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    });

    el.btnAutoFill.addEventListener("click", () => {
      if(!confirm("90일 키워드/유형 자동 배치를 적용할까요? (이미 입력된 Day는 유지됩니다)")) return;
      autoFill90Days();
      saveState();
      renderAll();
    });

    el.chips.forEach(ch => ch.addEventListener("click", () => {
      el.chips.forEach(x => x.dataset.active = "false");
      ch.dataset.active = "true";
      state.filter = ch.dataset.filter;
      saveState();
      renderCalendar();
    }));

    el.search.addEventListener("input", () => { state.search = el.search.value; saveState(); renderCalendar(); });
    el.typeFilter.addEventListener("change", () => { state.typeFilter = el.typeFilter.value; saveState(); renderCalendar(); });
    el.intentFilter.addEventListener("change", () => { state.intentFilter = el.intentFilter.value; saveState(); renderCalendar(); });

    // NEW: prompt
    el.btnMakePrompt.addEventListener("click", () => {
      applyEditorToDay();
      const d = getDay(state.selectedDay);
      el.promptText.value = buildPrompt(d, state.selectedDay);
      saveState();
      renderStats();
      renderCalendar();
    });

    el.btnCopyPrompt.addEventListener("click", async () => {
      const text = el.promptText.value || "";
      if(!text.trim()) return alert("복사할 프롬프트가 없습니다. 먼저 생성하세요.");
      try{
        await navigator.clipboard.writeText(text);
        alert("프롬프트를 복사했습니다.");
      }catch(e){
        el.promptText.select();
        document.execCommand("copy");
        alert("프롬프트를 복사했습니다.");
      }
    });
  }

  function renderAll(){
    renderStats();
    renderEditor();
    renderCalendar();
    el.search.value = state.search || "";
    el.typeFilter.value = state.typeFilter || "all";
    el.intentFilter.value = state.intentFilter || "all";
    const f = state.filter || "all";
    el.chips.forEach(x => x.dataset.active = (x.dataset.filter===f) ? "true" : "false");
  }

  function renderStats(){
    const done = state.days.filter(d => d.done).length;
    const pct = Math.round((done/90)*100);
    const leadsSum = state.days.reduce((a,d)=>a+(Number(d.leads)||0),0);

    el.doneCount.textContent = String(done);
    el.progressPct.textContent = `${pct}%`;
    el.leadCount.textContent = String(leadsSum);

    const convCount = state.days.filter(d => conversionTypes.has(d.postType)).length;
    const convPct = Math.round((convCount/90)*100);
    el.convRatio.textContent = `${convPct}%`;

    const linkDays = state.days.filter(d => d.checks?.link5 === true).length;
    el.linkDiscipline.textContent = String(linkDays);

    el.weekTarget.textContent = "14";

    const cur = getDay(state.selectedDay);
    el.ctaClicksVal.textContent = String(cur.ctaClicks||0);
    el.leadsVal.textContent = String(cur.leads||0);
  }

  function renderEditor(){
    const d = getDay(state.selectedDay);
    el.dayLabel.textContent = `Day ${state.selectedDay}`;
    el.titleKeyword.value = d.titleKeyword || "";
    el.url.value = d.url || "";
    el.resultMemo.value = d.resultMemo || "";
    el.postType.value = d.postType || "전환형-비교결단";
    el.intent.value = d.intent || "고의도";
    el.notes.value = d.notes || "";
    el.ctaClicks.value = d.ctaClicks ?? 0;
    el.leads.value = d.leads ?? 0;

    el.checklist.innerHTML = "";
    const checks = d.checks || {};
    defaultChecklist.forEach(item => {
      const wrap = document.createElement("div");
      wrap.className = "check";
      const box = document.createElement("input");
      box.type = "checkbox";
      box.checked = !!checks[item.key];
      box.addEventListener("change", () => {
        checks[item.key] = box.checked;
        d.checks = checks;
        saveState();
        renderStats();
        renderCalendar();
      });

      const txt = document.createElement("div");
      txt.style.flex = "1";
      const t = document.createElement("div");
      t.className="t";
      t.textContent = item.title;
      const desc = document.createElement("div");
      desc.className="d";
      desc.textContent = item.desc;
      txt.appendChild(t); txt.appendChild(desc);

      wrap.appendChild(box);
      wrap.appendChild(txt);
      el.checklist.appendChild(wrap);
    });
  }

  function applyEditorToDay(){
    const d = getDay(state.selectedDay);
    d.titleKeyword = el.titleKeyword.value.trim();
    d.url = el.url.value.trim();
    d.resultMemo = el.resultMemo.value.trim();
    d.postType = el.postType.value;
    d.intent = el.intent.value;
    d.notes = el.notes.value.trim();
    d.ctaClicks = Number(el.ctaClicks.value || 0);
    d.leads = Number(el.leads.value || 0);
  }

  function renderCalendar(){
    el.calendar.innerHTML = "";
    const start = parseDate(state.startDate);

    const filter = state.filter || "all";
    const q = (state.search || "").toLowerCase().trim();
    const tf = state.typeFilter || "all";
    const inf = state.intentFilter || "all";

    for(let i=1;i<=90;i++){
      const d = getDay(i);

      if(filter === "done" && !d.done) continue;
      if(filter === "todo" && d.done) continue;
      if(filter === "leads" && !(Number(d.leads)||0)) continue;

      if(tf !== "all" && d.postType !== tf) continue;
      if(inf !== "all" && d.intent !== inf) continue;

      if(q){
        const hay = `${d.titleKeyword||""} ${d.postType||""} ${d.intent||""}`.toLowerCase();
        if(!hay.includes(q)) continue;
      }

      const date = addDays(start, i-1);
      const box = document.createElement("div");
      box.className = "day" + (i === state.selectedDay ? " selected" : "");
      box.addEventListener("click", () => {
        state.selectedDay = i;
        el.daySelect.value = String(i);
        saveState();
        renderAll();
      });

      const top = document.createElement("div");
      top.className="num";
      const left = document.createElement("span");
      left.textContent = `D${String(i).padStart(2,"0")} · ${formatMMDD(date)}`;
      const badge = document.createElement("span");

      const hasLeads = (Number(d.leads)||0) > 0;
      if(hasLeads){
        badge.className="badge bad";
        badge.textContent = `리드 ${d.leads}`;
      }else if(d.done){
        badge.className="badge good";
        badge.textContent = "완료";
      }else{
        badge.className="badge warn";
        badge.textContent = "대기";
      }

      top.appendChild(left);
      top.appendChild(badge);

      const mini = document.createElement("div");
      mini.className="mini";
      if(d.intent) mini.appendChild(tag(d.intent));
      if(d.postType) mini.appendChild(tag(shortType(d.postType)));
      if(d.titleKeyword){
        const kw = d.titleKeyword.split("///")[1] ? d.titleKeyword.split("///")[1].trim() : d.titleKeyword.trim();
        if(kw) mini.appendChild(tag(clip(kw, 10)));
      }

      box.appendChild(top);
      box.appendChild(mini);
      el.calendar.appendChild(box);
    }
  }

  function tag(text){ const s = document.createElement("span"); s.textContent = text; return s; }
  function clip(s,n){ return s.length>n ? s.slice(0,n)+"…" : s; }
  function shortType(t){
    if(t.startsWith("전환형-")) return t.replace("전환형-","전환/");
    if(t.startsWith("신뢰형-")) return t.replace("신뢰형-","신뢰/");
    if(t.startsWith("SEO형-")) return t.replace("SEO형-","SEO/");
    return t;
  }

  function autoFill90Days(){
    for(let i=1;i<=90;i++){
      const d = getDay(i);
      if(d.titleKeyword && d.titleKeyword.trim()) continue;

      if(i<=seedTitles.length){
        d.titleKeyword = seedTitles[i-1];
      }else{
        const idx = i - seedTitles.length;
        const pack = generateKeywordPack(idx);
        d.titleKeyword = `${pack.title}///${pack.keyword}`;
      }

      const r = (i<=45) ? i % 10 : i % 12;
      if(i<=45){
        if(r<=5){ d.intent="고의도"; d.postType = (r%2===0) ? "전환형-실패경고" : "전환형-비교결단"; }
        else if(r<=8){ d.intent="중의도"; d.postType = "전환형-위기대응"; }
        else{ d.intent="저의도"; d.postType = "SEO형-기본정보"; }
      }else{
        if(r<=4){ d.intent="고의도"; d.postType = (r%2===0) ? "전환형-비교결단" : "전환형-실패경고"; }
        else if(r<=8){ d.intent="중의도"; d.postType = (r%2===0) ? "전환형-위기대응" : "신뢰형-승인사례"; }
        else{ d.intent="저의도"; d.postType = "SEO형-기본정보"; }
      }

      if(!d.checks) d.checks = {};
      defaultChecklist.forEach(x => { if(typeof d.checks[x.key] !== "boolean") d.checks[x.key] = false; });
    }
  }

  function generateKeywordPack(i){
    const angles = [
      ["비용", "비용"], ["변제금", "변제금"], ["기각", "기각"], ["금지명령", "금지명령"],
      ["폐지", "폐지"], ["재신청", "재신청"], ["보정", "보정명령"], ["서류", "준비서류"],
      ["기간", "기간"], ["배우자", "배우자 재산"], ["통장압류", "통장압류"], ["채권자", "채권자 이의신청"],
      ["소득", "소득증빙"], ["재산", "재산 목록"], ["변제계획", "변제계획안"],
    ];
    const verbs = [
      ["한 번에 정리", "정리"], ["실패하는 이유", "실패 이유"], ["피하는 방법", "예방"],
      ["가능 여부", "가능"], ["현실 기준", "기준"], ["체크리스트", "체크리스트"],
      ["주의할 점", "주의"], ["대응 방법", "대응"], ["필수 준비", "준비"],
    ];
    const ang = angles[i % angles.length];
    const vb = verbs[i % verbs.length];
    const title = `개인회생 ${ang[0]} ${vb[0]}`;
    const keyword = `개인회생 ${ang[1]}`;
    return {title, keyword};
  }

  // NEW: Prompt builder
  function buildPrompt(dayData, dayNumber){
    const tk = (dayData.titleKeyword || "").trim();
    const parts = tk.split("///");
    const seoTitle = (parts[0] || "").trim();
    const mainKeyword = (parts[1] || parts[0] || "").trim();

    const type = dayData.postType || "전환형-비교결단";
    const intent = dayData.intent || "고의도";

    const toneGuide = (() => {
      if(type === "전환형-실패경고") return "긴장감(리스크 회피) 중심으로, 독자를 겁주지 말고 ‘손해 최소화’로 설득";
      if(type === "전환형-비교결단") return "비교표/체크리스트로 ‘지금 결정’이 쉬워지게 설계";
      if(type === "전환형-위기대응") return "지금 당장 필요한 대응 순서(1~5단계)로 안정감 주기";
      if(type === "신뢰형-승인사례") return "사례 기반으로 불안 완화 + 신뢰 구축(조건/한계도 함께)";
      return "기초 정의→절차→주의점→다음 행동으로 깔끔하게";
    })();

    const intentGuide = (() => {
      if(intent === "고의도") return "상담/제휴 전환에 가까운 독자. 비용/기간/기각/압류 같은 ‘즉시 해결 욕구’ 강조";
      if(intent === "중의도") return "문제 해결 탐색 단계. 절차/서류/보정 같은 ‘준비 행동’ 강조";
      return "입문 단계. 용어/기본 요건/흐름을 쉽게";
    })();

    // v1.6 Patch rules (hard)
    const hardRules = [
      "H2는 총 7개 고정: #1~#5 본문, #6 FAQ, #7 마무리",
      "H3는 반드시 포함: H2 #1~#6 각각 아래 H3 최소 1개(필수), H2 #7 아래 H3 금지",
      "H2/H3 뒤에는 p 1개 이상 필수. 문단 길면 2~3문장마다 <br><br> 삽입",
      "CTA 총 3개 분산: CTA#1은 H2#2 내부(H3 이후 p 1개 뒤), CTA#2는 H2#4 내부(H3 이후 p 1개 뒤), CTA#3는 FAQ(H2#6) 카드 2개 이상 나온 뒤(면책 조항 직전)",
      "CTA 바로 뒤에 <h2> 금지. CTA 뒤에는 일반 <p> 1개 이상 먼저 배치",
      "애드센스 2회 고정: 목차 직후 1회, H2#3 전후 1회 / data-ad-client, slot 값 고정 / <script>, onclick 금지",
      "FAQ는 Q1~Q5 정확히 5개 고정(형식 통일)",
      "과장/단정 표현 금지(100%, 무조건, 확정 등 금지) + ‘사안별 다를 수 있음’ 명시",
    ].join("\n- ");

    const ctaPsych = [
      "CTA 문구는 ‘지금 안 하면 생기는 손해’(기각/지연/압류/보정 실패)를 짧게 암시하고, 버튼 텍스트는 행동 1개로 명확히",
      "버튼 위에 1문장 ‘완충 p’로 필요성(왜 지금) 만들어라",
      "버튼 아래에 1문장 ‘완충 p’로 안심(과장 없이) 제공",
    ].join("\n- ");

    const outputSpec = [
      "출력은 HTML 본문으로만(최상단 wrapper div 포함 가능)",
      "목차 포함",
      "비교표 1개 포함(전환형-비교결단일 때는 반드시)",
      "면책 조항 포함(마지막에)",
      "해시태그는 맨 아래 10개 내외",
    ].join("\n- ");

    return [
`[역할]
너는 ‘개인회생’ 생활법률 머니사이트용 콘텐츠 엔진이다. 목표는 SEO 유입 + 제휴 전환(상담/문의)이다.

[오늘 Day]
- Day: ${dayNumber}
- 글유형: ${type}
- 의도: ${intent}
- SEO 제목: ${seoTitle || "(제목을 입력하세요)"}
- 메인 키워드: ${mainKeyword || "(키워드를 입력하세요)"}

[톤/설계 가이드]
- 글 톤: ${toneGuide}
- 독자 상태: ${intentGuide}

[하드 규칙(절대 위반 금지)]
- ${hardRules}

[CTA 심리 설계(강제 적용)]
- ${ctaPsych}

[콘텐츠 출력 스펙]
- ${outputSpec}

[H2 구성(고정)]
H2 #1: (문제 공감 + 지금 왜 급한지)
H2 #2: (핵심 법적/절차 근거 + CTA#1 삽입)
H2 #3: (준비물/서류/절차 단계)
H2 #4: (선택지 비교/결정 가이드 + CTA#2 삽입)
H2 #5: (비용/기간/기각 리스크/결과 예측 - 케이스별 범위로)
H2 #6: (FAQ 5개 고정: Q1~Q5) — FAQ 2개 출력 후 CTA#3 삽입
H2 #7: (마무리: 다음 행동 제시 + 면책 조항)

[FAQ 고정 질문(그대로 사용)]
Q1. 개인회생 신청 자격이 애매하면 어디서부터 확인하나요?
Q2. 개인회생 변호사 비용은 왜 차이가 나나요?
Q3. 보정명령/보정권고가 나오면 어떻게 대응해야 하나요?
Q4. 금지명령이 늦어지면 압류/추심이 계속되나요?
Q5. 기각/폐지된 뒤 재신청은 언제 가능한가요?

[생성 지시]
위 조건을 모두 만족하는 HTML 본문을 작성해라. 
키워드(${mainKeyword})는 본문에 자연스럽게 반복하되, 과장/단정은 금지한다.
`.trim()
    ].join("\n");
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `lawgear_pacemaker_90d_backup_${state.startDate || formatDate(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const s = JSON.parse(raw);
        if(s && Array.isArray(s.days) && s.days.length === 90) return normalizeState(s);
      }catch(e){}
    }
    const days = Array.from({length:90}).map((_,i)=>({
      day: i+1,
      done:false,
      titleKeyword:"",
      url:"",
      resultMemo:"",
      postType:"전환형-비교결단",
      intent:"고의도",
      notes:"",
      ctaClicks:0,
      leads:0,
      checks: Object.fromEntries(defaultChecklist.map(x=>[x.key,false])),
    }));
    return normalizeState({
      startDate:"",
      selectedDay:1,
      filter:"all",
      search:"",
      typeFilter:"all",
      intentFilter:"all",
      days,
    });
  }

  function normalizeState(s){
    if(!s.selectedDay) s.selectedDay = 1;
    if(!s.filter) s.filter = "all";
    if(!s.search) s.search = "";
    if(!s.typeFilter) s.typeFilter = "all";
    if(!s.intentFilter) s.intentFilter = "all";
    if(!s.days || s.days.length !== 90){
      s.days = Array.from({length:90}).map((_,i)=>({day:i+1}));
    }
    s.days = s.days.map((d,i)=>({
      day: i+1,
      done: !!d.done,
      titleKeyword: d.titleKeyword || "",
      url: d.url || "",
      resultMemo: d.resultMemo || "",
      postType: d.postType || "전환형-비교결단",
      intent: d.intent || "고의도",
      notes: d.notes || "",
      ctaClicks: Number(d.ctaClicks||0),
      leads: Number(d.leads||0),
      checks: normalizeChecks(d.checks),
    }));
    return s;
  }

  function normalizeChecks(c){
    const obj = {};
    defaultChecklist.forEach(x => obj[x.key] = (c && typeof c[x.key]==="boolean") ? c[x.key] : false);
    return obj;
  }

  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function getDay(n){ return state.days[n-1]; }

  // Date helpers
  function parseDate(s){
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s||"");
    if(!m) return new Date();
    const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    if(isNaN(d.getTime())) return new Date();
    return d;
  }
  function addDays(date, days){ const d = new Date(date); d.setDate(d.getDate()+days); return d; }
  function formatDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function formatMMDD(d){
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${m}/${da}`;
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function computeDayFromStart(startStr, now){
    const start = parseDate(startStr);
    const ms = now.getTime() - start.getTime();
    const days = Math.floor(ms / (1000*60*60*24)) + 1;
    return days;
  }
})();
</script>
</body>
</html>
